<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ç°¡å ±ç”Ÿæˆå™¨ | Text to PPTX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ PptxGenJS (ç”Ÿæˆ PPT çš„æ ¸å¿ƒåº«) -->
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <!-- å¼•å…¥ Marked (è§£æ Markdown) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: white; }
        
        /* ç°¡å ±é è¦½å¡ç‰‡ */
        .slide-preview {
            aspect-ratio: 16/9;
            background: white;
            color: #333;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            font-size: 0.8rem;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: relative;
            transition: transform 0.2s;
        }
        .slide-preview:hover { transform: scale(1.02); z-index: 10; }
        
        .slide-title { font-size: 1.2em; font-weight: bold; color: #2563eb; margin-bottom: 10px; border-bottom: 2px solid #eee; padding-bottom: 5px; }
        .slide-content { flex-grow: 1; font-size: 0.9em; line-height: 1.5; }
        .slide-content ul { list-style-type: disc; padding-left: 20px; }
        .slide-footer { margin-top: 10px; font-size: 0.7em; color: #888; border-top: 1px solid #eee; padding-top: 5px; }
        
        /* è¼‰å…¥å‹•ç•« */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            width: 36px; height: 36px;
            border-radius: 50%;
            border-left-color: #f43f5e;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <!-- è¨­å®šè¦–çª— -->
    <div id="apiModal" class="fixed inset-0 bg-black/80 z-[200] hidden items-center justify-center backdrop-blur-sm">
        <div class="bg-gray-800 p-6 rounded-xl w-full max-w-md border border-gray-700 shadow-2xl">
            <h3 class="text-xl font-bold text-white mb-2">ğŸ”‘ è¨­å®š Gemini API Key</h3>
            <p class="text-gray-400 text-sm mb-4">
                æœ¬å·¥å…·éœ€è¦ AI ä¾†åˆ†ææ‚¨çš„æ–‡å­—ä¸¦è¦åŠƒç°¡å ±çµæ§‹ã€‚<br>
                Key åƒ…å„²å­˜æ–¼ç€è¦½å™¨ï¼Œå®‰å…¨ç„¡è™ã€‚
            </p>
            <input type="password" id="apiKeyInput" class="w-full p-3 bg-gray-900 border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-rose-500 outline-none" placeholder="è²¼ä¸Š API Key...">
            <div class="flex justify-end gap-3 mt-6">
                <button class="px-4 py-2 text-gray-400 hover:text-white" onclick="closeApiModal()">å–æ¶ˆ</button>
                <button class="px-6 py-2 bg-rose-600 hover:bg-rose-700 text-white rounded-lg" onclick="saveApiKey()">å„²å­˜è¨­å®š</button>
            </div>
        </div>
    </div>

    <!-- å°è¦½åˆ— -->
    <nav class="border-b border-slate-700 bg-slate-900/80 backdrop-blur shrink-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <a href="index.html" class="flex items-center gap-2 text-slate-400 hover:text-white transition-colors text-sm font-medium border border-slate-700 px-3 py-1.5 rounded-lg bg-slate-800">
                    <span>ğŸ </span>
                </a>
                <span class="font-bold text-lg text-rose-400 tracking-wide">AI ç°¡å ±ç”Ÿæˆå™¨</span>
            </div>
            
            <div class="flex items-center gap-3">
                <button onclick="openApiModal()" class="text-gray-400 hover:text-white" title="è¨­å®š API Key">âš™ï¸</button>
            </div>
        </div>
    </nav>

    <!-- ä¸»ç•«é¢ -->
    <main class="flex-grow flex flex-col md:flex-row h-full overflow-hidden">
        
        <!-- å·¦å´ï¼šè¼¸å…¥å€ -->
        <div class="w-full md:w-1/3 p-6 border-r border-slate-700 flex flex-col bg-slate-900 overflow-y-auto">
            <div class="mb-4">
                <h2 class="text-xl font-bold mb-2 text-white">1. è¼¸å…¥å…§å®¹</h2>
                <p class="text-sm text-slate-400 mb-4">è²¼ä¸Š NotebookLM çš„ç­†è¨˜ã€æ–‡ç« æˆ–ä»»ä½•æ–‡å­—ã€‚</p>
                <textarea id="textInput" class="w-full h-64 bg-slate-800 border border-slate-700 rounded-xl p-4 text-slate-200 focus:outline-none focus:border-rose-500 resize-none text-sm leading-relaxed mb-4" placeholder="åœ¨æ­¤è²¼ä¸Šæ–‡å­—..."></textarea>
                
                <div class="flex gap-2">
                    <button onclick="generateSlides()" id="btn-generate" class="flex-1 py-3 bg-gradient-to-r from-rose-600 to-pink-600 hover:from-rose-500 hover:to-pink-500 text-white rounded-lg font-bold shadow-lg transition-all flex justify-center items-center gap-2">
                        <span>âœ¨ AI ç”Ÿæˆå¤§ç¶±</span>
                    </button>
                    <button onclick="clearText()" class="px-4 py-3 border border-slate-600 text-slate-400 hover:text-white rounded-lg transition-all">
                        æ¸…ç©º
                    </button>
                </div>
            </div>

            <!-- æç¤ºå€ -->
            <div class="bg-slate-800/50 p-4 rounded-lg border border-slate-700/50 text-xs text-slate-400">
                <p class="font-bold text-slate-300 mb-1">ğŸ’¡ å°æ’‡æ­¥ï¼š</p>
                <p>å¦‚æœä½ æœ‰ NotebookLM çš„ã€ŒéŸ³è¨Šç¸½è¦½ (Podcast)ã€ï¼Œå¯ä»¥å…ˆç”¨è½‰éŒ„å·¥å…·è½‰æˆæ–‡å­—è²¼éä¾†ï¼Œæ•ˆæœæœ€å¥½ï¼</p>
            </div>
        </div>

        <!-- å³å´ï¼šé è¦½èˆ‡ä¸‹è¼‰å€ -->
        <div class="w-full md:w-2/3 p-6 bg-slate-800/50 overflow-y-auto relative">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-white">2. é è¦½ç°¡å ± <span id="slide-count" class="text-sm font-normal text-slate-400 bg-slate-800 px-2 py-1 rounded ml-2 hidden">0 å¼µ</span></h2>
                <button onclick="downloadPPT()" id="btn-download" class="hidden px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-bold shadow-lg transition-all flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                    ä¸‹è¼‰ PowerPoint (.pptx)
                </button>
            </div>

            <!-- è¼‰å…¥ä¸­å‹•ç•« -->
            <div id="loading" class="hidden absolute inset-0 bg-slate-900/80 z-20 flex flex-col items-center justify-center">
                <div class="spinner mb-4"></div>
                <p class="text-rose-400 animate-pulse text-lg font-bold">AI æ­£åœ¨è¨­è¨ˆç°¡å ±æ¶æ§‹...</p>
                <p class="text-slate-500 text-sm mt-2">æ­£åœ¨åˆ†ææ–‡å­—é‚è¼¯ã€æ‹†åˆ†ç« ç¯€...</p>
            </div>

            <!-- ç©ºç‹€æ…‹ -->
            <div id="empty-state" class="flex flex-col items-center justify-center h-64 text-slate-500 border-2 border-dashed border-slate-700 rounded-xl">
                <svg class="w-16 h-16 mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/></svg>
                <p>è«‹å…ˆåœ¨å·¦å´è¼¸å…¥æ–‡å­—ä¸¦é»æ“Šç”Ÿæˆ</p>
            </div>

            <!-- ç°¡å ±ç¶²æ ¼ -->
            <div id="slides-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 pb-20">
                <!-- JS å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>

    </main>

    <script>
        // --- å…¨åŸŸè®Šæ•¸ ---
        let generatedSlides = []; // å„²å­˜ç”Ÿæˆçš„ç°¡å ±è³‡æ–™
        const envApiKey = ""; 
        
        // --- æ ¸å¿ƒåŠŸèƒ½ ---

        async function generateSlides() {
            const text = document.getElementById('textInput').value.trim();
            if (!text) { alert("è«‹å…ˆè¼¸å…¥æ–‡å­—å…§å®¹ï¼"); return; }

            const apiKey = localStorage.getItem('gemini_api_key') || envApiKey;
            if (!apiKey) { openApiModal(); return; }

            // UI ç‹€æ…‹åˆ‡æ›
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('loading').classList.add('flex');
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('slides-grid').innerHTML = '';
            document.getElementById('btn-download').classList.add('hidden');

            try {
                // 1. å‘¼å« Gemini API
                const prompt = `
                    ä½ æ˜¯å°ˆæ¥­çš„ç°¡å ±è¨­è¨ˆå¸«ã€‚è«‹å°‡ä»¥ä¸‹æ–‡å­—è½‰æ›ç‚º PowerPoint ç°¡å ±çš„çµæ§‹ã€‚
                    
                    è¦å‰‡ï¼š
                    1. è¼¸å‡ºç‚ºç´” JSON æ ¼å¼é™£åˆ—ï¼Œä¸è¦æœ‰ä»»ä½• Markdown æ¨™è¨˜ã€‚
                    2. æ¯ä¸€é ç°¡å ±åŒ…å«ï¼štitle (æ¨™é¡Œ), content (åˆ—é»å…§å®¹é™£åˆ—), notes (è¬›è€…å‚™å¿˜ç¨¿)ã€‚
                    3. ç¬¬ä¸€é å¿…é ˆæ˜¯å°é¢ (Cover)ã€‚
                    4. å…§å®¹è«‹ç²¾ç°¡ç‚ºåˆ—é» (Bullet points)ã€‚
                    5. èªè¨€ï¼šç¹é«”ä¸­æ–‡ã€‚
                    
                    æ–‡å­—å…§å®¹ï¼š
                    ${text.substring(0, 15000)} 
                `; // é™åˆ¶é•·åº¦é¿å…çˆ†æ‰

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();
                if (data.error) throw new Error(data.error.message);

                // 2. è§£æ JSON
                let rawText = data.candidates[0].content.parts[0].text;
                // æ¸…ç† Markdown code block æ¨™è¨˜
                rawText = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
                
                generatedSlides = JSON.parse(rawText);

                // 3. æ¸²æŸ“é è¦½
                renderPreview(generatedSlides);

            } catch (error) {
                console.error(error);
                alert("ç”Ÿæˆå¤±æ•—ï¼š\n" + error.message);
                document.getElementById('empty-state').classList.remove('hidden');
            } finally {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('loading').classList.remove('flex');
            }
        }

        function renderPreview(slides) {
            const grid = document.getElementById('slides-grid');
            grid.innerHTML = '';
            
            document.getElementById('slide-count').innerText = `${slides.length} å¼µ`;
            document.getElementById('slide-count').classList.remove('hidden');
            document.getElementById('btn-download').classList.remove('hidden');

            slides.forEach((slide, index) => {
                const div = document.createElement('div');
                div.className = 'slide-preview';
                
                // å…§å®¹è™•ç†ï¼šå¦‚æœæ˜¯é™£åˆ—å°±è½‰ ul liï¼Œå­—ä¸²å°±ç›´æ¥é¡¯ç¤º
                let contentHtml = '';
                if (Array.isArray(slide.content)) {
                    contentHtml = '<ul>' + slide.content.map(point => `<li>${point}</li>`).join('') + '</ul>';
                } else {
                    contentHtml = `<p>${slide.content || ''}</p>`;
                }

                div.innerHTML = `
                    <div class="text-xs text-gray-400 mb-1">Slide ${index + 1}</div>
                    <div class="slide-title">${slide.title}</div>
                    <div class="slide-content">${contentHtml}</div>
                    <div class="slide-footer">ğŸ“ å‚™å¿˜ï¼š${slide.notes ? slide.notes.substring(0, 30) + '...' : 'ç„¡'}</div>
                `;
                grid.appendChild(div);
            });
        }

        function downloadPPT() {
            if (generatedSlides.length === 0) return;

            const pptx = new PptxGenJS();
            pptx.layout = 'LAYOUT_16x9';
            pptx.author = 'Sandy AI Tools';
            pptx.company = 'AI Generated';
            pptx.title = generatedSlides[0].title || 'Presentation';

            // å®šç¾©æ¯ç‰‡æ¨£å¼ (Master Slide)
            pptx.defineSlideMaster({
                title: 'MASTER_SLIDE',
                background: { color: 'F1F5F9' }, // æ·ºç°åº•
                objects: [
                    { rect: { x: 0, y: 0, w: '100%', h: 0.7, fill: { color: 'E11D48' } } }, // é ‚éƒ¨ç«ç‘°ç´…æ¢
                    { text: { text: 'Generated by Sandy AI', options: { x: 0.5, y: 5.2, w: '90%', align: 'left', fontSize: 10, color: '94A3B8' } } } // é å°¾
                ]
            });

            generatedSlides.forEach((slide, index) => {
                let s = pptx.addSlide({ masterName: 'MASTER_SLIDE' });
                
                // æ¨™é¡Œ
                s.addText(slide.title, { x: 0.5, y: 0.5, w: '90%', fontSize: 24, bold: true, color: '1E293B' });

                // å…§å®¹ (è‡ªå‹•åˆ¤æ–·æ˜¯é™£åˆ—é‚„æ˜¯å­—ä¸²)
                if (Array.isArray(slide.content)) {
                    // è™•ç†åˆ—é»
                    const items = slide.content.map(item => ({ text: item, options: { fontSize: 16, breakLine: true, bullet: true, color: '334155' } }));
                    s.addText(items, { x: 0.5, y: 1.5, w: '90%', h: 3.5, align: 'left', valign: 'top' });
                } else {
                    s.addText(slide.content, { x: 0.5, y: 1.5, w: '90%', fontSize: 16, color: '334155' });
                }

                // è¬›è€…å‚™å¿˜ç¨¿
                if (slide.notes) {
                    s.addNotes(slide.notes);
                }
            });

            // åŒ¯å‡º
            const fileName = `Presentation_${new Date().toISOString().slice(0,10)}.pptx`;
            pptx.writeFile({ fileName: fileName });
        }

        // --- å…¶ä»–å·¥å…·å‡½å¼ ---
        function clearText() {
            if(confirm("ç¢ºå®šè¦æ¸…ç©ºå—ï¼Ÿ")) {
                document.getElementById('textInput').value = '';
                document.getElementById('slides-grid').innerHTML = '';
                document.getElementById('empty-state').classList.remove('hidden');
                document.getElementById('btn-download').classList.add('hidden');
                document.getElementById('slide-count').classList.add('hidden');
                generatedSlides = [];
            }
        }

        function openApiModal() { document.getElementById('apiModal').style.display = 'flex'; document.getElementById('apiKeyInput').value = localStorage.getItem('gemini_api_key') || ''; }
        function closeApiModal() { document.getElementById('apiModal').style.display = 'none'; }
        function saveApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (key) { localStorage.setItem('gemini_api_key', key); alert('API Key å·²å„²å­˜ï¼'); closeApiModal(); }
        }
    </script>
</body>
</html>