<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScreenCast Pro | æœƒè­°éŒ„å½±åŠ©æ‰‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { 
            background-color: #020617; 
            color: white; 
            font-family: 'Inter', sans-serif; 
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
        }
        
        .glass-panel {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .rec-dot {
            width: 10px; height: 10px;
            background-color: #ef4444;
            border-radius: 50%;
            display: inline-block;
            box-shadow: 0 0 15px #ef4444;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            70% { transform: scale(1); opacity: 1; box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(1); opacity: 1; box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        /* è½å¯«æ–‡å­—å€ç‰¹æ•ˆ */
        .transcript-box {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: border-color 0.3s;
        }
        .transcript-box:focus-within {
            border-color: #3b82f6;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.2);
        }

        .warning-banner { animation: slideDown 0.5s ease-out; }
        @keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }
    </style>
</head>
<body class="min-h-screen flex flex-col overflow-x-hidden">

    <!-- ç’°å¢ƒé™åˆ¶è­¦å‘Š -->
    <div id="iframe-warning" class="hidden fixed top-0 left-0 w-full bg-orange-600/95 backdrop-blur text-white text-xs font-bold py-3 px-4 text-center z-[100] warning-banner border-b border-orange-400 shadow-lg">
        âš ï¸ é è¦½æ¨¡å¼é™åˆ¶ï¼šè«‹é»æ“Šå³ä¸Šè§’ã€Œä¸‹è¼‰ã€è‡³é›»è…¦åŸ·è¡Œï¼Œä»¥å•Ÿç”¨éŒ„å½±èˆ‡èªéŸ³è¾¨è­˜åŠŸèƒ½ã€‚
    </div>

    <!-- Header -->
    <header class="bg-slate-900/50 backdrop-blur-md border-b border-white/5 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <a href="index.html" class="flex items-center justify-center w-10 h-10 rounded-xl bg-slate-800 text-slate-400 hover:bg-rose-600 hover:text-white transition-all shadow-lg border border-slate-700 group">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 group-hover:scale-110 transition-transform" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
                    </svg>
                </a>
                <div>
                    <h1 class="text-xl font-black bg-clip-text text-transparent bg-gradient-to-r from-rose-500 via-red-500 to-orange-500 tracking-tight">
                        ScreenCast <span class="font-light">AI</span>
                    </h1>
                    <p class="text-[10px] text-slate-500 tracking-widest uppercase">Recorder & Transcriber</p>
                </div>
            </div>
            
            <div id="status-indicator" class="hidden flex items-center gap-3 px-4 py-1.5 bg-slate-900/80 border border-red-500/30 rounded-full shadow-[0_0_15px_rgba(239,68,68,0.2)]">
                <div class="rec-dot"></div>
                <span class="text-xs font-bold text-red-400 tracking-widest">REC</span>
                <span id="timer" class="text-sm font-mono text-white font-bold tabular-nums">00:00:00</span>
            </div>
        </div>
    </header>

    <main class="flex-grow w-full max-w-7xl mx-auto p-6 flex flex-col lg:flex-row gap-6">
        
        <!-- å·¦å´ï¼šéŒ„å½±å€ -->
        <div class="flex-grow flex flex-col gap-6 w-full lg:w-2/3">
            <!-- é è¦½è¦–çª— -->
            <div class="w-full relative group">
                <div class="absolute inset-0 bg-gradient-to-tr from-rose-500/10 to-blue-500/10 rounded-3xl blur-xl opacity-50 group-hover:opacity-75 transition-opacity duration-700"></div>
                <div class="relative w-full aspect-video bg-black/80 rounded-3xl border border-white/10 flex items-center justify-center overflow-hidden shadow-2xl backdrop-blur-sm">
                    <video id="preview" class="w-full h-full object-contain" autoplay muted playsinline></video>
                    
                    <!-- åˆå§‹æç¤º -->
                    <div id="placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-slate-500 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0MCIgaGVpZ2h0PSI0MCI+CjxwYXRoIGQ9Ik0wIDBoNDB2NDBIMHoiIGZpbGw9Im5vbmUiLz4KPHBhdGggZD0iTTAgNDBMOF4wIDQwaDQwTDAgMHoiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC4wMykiLz4KPC9zdmc+')]">
                        <div class="w-24 h-24 bg-slate-800/50 rounded-full flex items-center justify-center mb-6 group-hover:scale-110 transition-transform duration-500 border border-slate-700 group-hover:border-rose-500/50">
                            <svg class="w-12 h-12 text-slate-400 group-hover:text-rose-400 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                        </div>
                        <h2 class="text-2xl font-bold text-white mb-2">æº–å‚™éŒ„è£½</h2>
                        <p class="text-sm text-slate-400">æ”¯æ´å…¨è¢å¹•ã€è¦–çª—æˆ–åˆ†é </p>
                    </div>
                </div>
            </div>

            <!-- æ§åˆ¶é¢æ¿ -->
            <div class="glass-panel p-5 rounded-2xl flex flex-col md:flex-row items-center gap-6">
                <!-- è¨­å®šé–‹é—œ -->
                <div class="flex flex-col gap-2 w-full md:w-auto">
                    <label class="flex items-center gap-3 cursor-pointer p-2 hover:bg-white/5 rounded-lg transition-colors">
                        <input type="checkbox" id="toggle-mic" class="accent-rose-500 w-5 h-5 cursor-pointer" checked>
                        <span class="text-sm font-bold text-slate-300">éº¥å…‹é¢¨ (éŒ„è£½è§£èªª)</span>
                    </label>
                    <label class="flex items-center gap-3 cursor-pointer p-2 hover:bg-white/5 rounded-lg transition-colors">
                        <input type="checkbox" id="toggle-audio" class="accent-emerald-500 w-5 h-5 cursor-pointer" checked>
                        <span class="text-sm font-bold text-slate-300">ç³»çµ±éŸ³æ•ˆ (é›»è…¦è²éŸ³)</span>
                    </label>
                </div>

                <div class="h-12 w-px bg-slate-700 hidden md:block"></div>

                <!-- éŒ„å½±æŒ‰éˆ• -->
                <div class="flex-grow w-full flex gap-4">
                    <button id="btn-start" onclick="startRecording()" class="flex-1 h-14 bg-gradient-to-r from-rose-600 to-red-600 hover:from-rose-500 hover:to-red-500 text-white rounded-xl font-bold shadow-lg shadow-rose-900/50 transition-all active:scale-95 flex items-center justify-center gap-2 text-lg">
                        <span class="w-3 h-3 bg-white rounded-full animate-ping"></span>
                        é–‹å§‹éŒ„è£½
                    </button>
                    
                    <button id="btn-stop" onclick="stopRecording()" class="hidden flex-1 h-14 bg-slate-700 hover:bg-slate-600 text-white rounded-xl font-bold transition-all active:scale-95 flex items-center justify-center gap-2 border border-slate-500">
                        <span class="w-4 h-4 bg-red-500 rounded-sm"></span> åœæ­¢
                    </button>

                    <a id="btn-download" class="hidden flex-1 h-14 bg-emerald-600 hover:bg-emerald-500 text-white rounded-xl font-bold shadow-lg transition-all active:scale-95 flex items-center justify-center gap-2 cursor-pointer">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        ä¸‹è¼‰å½±ç‰‡
                    </a>
                </div>
            </div>
        </div>

        <!-- å³å´ï¼šæœƒè­°è¨˜éŒ„åŠ©æ‰‹ (STT) -->
        <div class="w-full lg:w-1/3 flex flex-col gap-4">
            <div class="glass-panel p-5 rounded-2xl h-full flex flex-col border-t-4 border-t-blue-500">
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-lg bg-blue-500/20 text-blue-400 flex items-center justify-center">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 11-6 0 3 3 0 016 0v6a3 3 0 01-3 3z"></path></svg>
                        </div>
                        <h3 class="font-bold text-white">æœƒè­°è¨˜éŒ„åŠ©æ‰‹</h3>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="toggle-stt" class="sr-only peer" onchange="toggleSTT(this.checked)">
                        <div class="w-9 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
                        <span class="ml-2 text-xs font-medium text-slate-400 peer-checked:text-blue-400">é–‹å•Ÿ</span>
                    </label>
                </div>

                <div class="flex-grow relative">
                    <textarea id="transcript-area" class="w-full h-full min-h-[300px] transcript-box bg-black/20 text-slate-300 p-4 rounded-xl resize-none text-sm leading-relaxed outline-none" placeholder="é–‹å•Ÿä¸Šæ–¹é–‹é—œï¼Œé€™è£¡å°‡æœƒå³æ™‚é¡¯ç¤ºèªéŸ³è½‰æ–‡å­—çš„å…§å®¹... (æ”¯æ´ Chrome / Edge ç€è¦½å™¨)" spellcheck="false"></textarea>
                    
                    <div id="stt-status" class="absolute bottom-4 right-4 text-xs text-blue-400 font-bold hidden items-center gap-2 bg-slate-900/80 px-2 py-1 rounded-md backdrop-blur">
                        <span class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></span> è†è½ä¸­...
                    </div>
                </div>

                <div class="mt-4 flex gap-2">
                    <button onclick="copyTranscript()" class="flex-1 py-2 bg-slate-700 hover:bg-slate-600 text-slate-200 rounded-lg text-xs font-bold transition-colors">
                        è¤‡è£½æ–‡å­— (Copy)
                    </button>
                    <button onclick="clearTranscript()" class="px-3 py-2 bg-slate-700 hover:bg-red-900/50 text-slate-400 hover:text-red-400 rounded-lg text-xs font-bold transition-colors">
                        æ¸…é™¤
                    </button>
                </div>
                
                <p class="mt-3 text-[10px] text-slate-500">
                    ğŸ’¡ å°æ’‡æ­¥ï¼šæœƒè­°çµæŸå¾Œï¼Œè¤‡è£½æ–‡å­—ç›´æ¥è²¼å…¥ NotebookLMï¼Œå³å¯å¿«é€Ÿç”Ÿæˆæœƒè­°æ‘˜è¦ã€‚
                </p>
            </div>
        </div>

    </main>

    <!-- åº•éƒ¨è­¦å‘Š -->
    <div class="fixed bottom-0 w-full bg-slate-900/90 backdrop-blur border-t border-slate-800 py-2 text-center pointer-events-none z-40">
        <p class="text-[10px] text-slate-500">
            âš ï¸ å»ºè­°ï¼šç‚ºé¿å…ç€è¦½å™¨è¨˜æ†¶é«” (RAM) ä¸è¶³ï¼Œå–®æ¬¡ 4K è¢å¹•éŒ„å½±å»ºè­°ä¸è¶…é 1 å°æ™‚ã€‚ç´”èªéŸ³/éœæ…‹ç•«é¢å¯éŒ„è£½æ›´ä¹…ã€‚
        </p>
    </div>

    <script>
        const preview = document.getElementById('preview');
        const placeholder = document.getElementById('placeholder');
        const btnStart = document.getElementById('btn-start');
        const btnStop = document.getElementById('btn-stop');
        const btnDownload = document.getElementById('btn-download');
        const statusIndicator = document.getElementById('status-indicator');
        const timerEl = document.getElementById('timer');
        const iframeWarning = document.getElementById('iframe-warning');
        
        // STT è®Šæ•¸
        const transcriptArea = document.getElementById('transcript-area');
        const sttStatus = document.getElementById('stt-status');
        let recognition;
        let isSttOn = false;

        // ç’°å¢ƒåµæ¸¬
        if (window.self !== window.top) iframeWarning.classList.remove('hidden');

        // --- è¢å¹•éŒ„å½±æ ¸å¿ƒ ---
        let mediaRecorder;
        let recordedChunks = [];
        let activeStream = null;
        let timerInterval;
        let startTime;

        async function startRecording() {
            const useMic = document.getElementById('toggle-mic').checked;
            const useSystemAudio = document.getElementById('toggle-audio').checked;

            try {
                const displayStream = await navigator.mediaDevices.getDisplayMedia({
                    video: { mediaSource: "screen" },
                    audio: useSystemAudio
                });

                let finalStream = displayStream;
                
                // æ··éŸ³é‚è¼¯
                if (useMic) {
                    const micStream = await navigator.mediaDevices.getUserMedia({ 
                        audio: { echoCancellation: true, noiseSuppression: true } 
                    });
                    
                    const audioContext = new AudioContext();
                    const dest = audioContext.createMediaStreamDestination();
                    
                    if (displayStream.getAudioTracks().length > 0) {
                        const sysSrc = audioContext.createMediaStreamSource(displayStream);
                        sysSrc.connect(dest);
                    }
                    const micSrc = audioContext.createMediaStreamSource(micStream);
                    micSrc.connect(dest);
                    
                    finalStream = new MediaStream([
                        ...displayStream.getVideoTracks(),
                        ...dest.stream.getAudioTracks()
                    ]);
                }

                activeStream = finalStream;
                preview.srcObject = displayStream;
                preview.muted = true;
                await preview.play();
                placeholder.classList.add('hidden');

                // å„ªå…ˆä½¿ç”¨é«˜å“è³ªç·¨ç¢¼
                let options = { mimeType: 'video/webm; codecs=vp9' };
                if (!MediaRecorder.isTypeSupported(options.mimeType)) options = { mimeType: 'video/webm' };

                mediaRecorder = new MediaRecorder(finalStream, options);
                mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
                
                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    btnDownload.href = url;
                    btnDownload.download = `Meeting_${new Date().toISOString().slice(0,19).replace('T','_')}.webm`;
                    btnDownload.classList.remove('hidden');
                    
                    preview.srcObject = null;
                    preview.src = url;
                    preview.muted = false;
                    preview.controls = true;
                    preview.loop = true;
                    
                    stopTimer();
                    resetUI();
                    if(activeStream) activeStream.getTracks().forEach(track => track.stop());
                    
                    // åœæ­¢ STT
                    if(isSttOn) toggleSTT(false);
                    document.getElementById('toggle-stt').checked = false;
                };

                recordedChunks = [];
                mediaRecorder.start(1000);
                
                btnStart.classList.add('hidden');
                btnDownload.classList.add('hidden');
                btnStop.classList.remove('hidden');
                statusIndicator.classList.remove('hidden');
                statusIndicator.classList.add('flex');
                
                startTimer();
                
                // è‡ªå‹•é–‹å•Ÿ STT (å¦‚æœå‹¾é¸)
                if(document.getElementById('toggle-stt').checked) startSTT();

                displayStream.getVideoTracks()[0].onended = () => stopRecording();

            } catch (err) {
                console.error(err);
                if (err.name === 'NotAllowedError') {
                    if (err.message.includes('permissions policy')) alert("âš ï¸ å®‰å…¨é™åˆ¶ï¼šè«‹ä¸‹è¼‰æ­¤ç¶²é è‡³é›»è…¦åŸ·è¡Œï¼Œä»¥å•Ÿç”¨éŒ„å½±åŠŸèƒ½ã€‚");
                    else alert("æ‚¨å–æ¶ˆäº†æ¬Šé™è«‹æ±‚ã€‚");
                }
                resetUI();
            }
        }

        function stopRecording() {
            if(mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
        }

        function resetUI() {
            btnStop.classList.add('hidden');
            btnStart.classList.remove('hidden');
            statusIndicator.classList.add('hidden');
            statusIndicator.classList.remove('flex');
        }

        // --- èªéŸ³è½‰æ–‡å­— (Speech to Text) ---
        function toggleSTT(enabled) {
            isSttOn = enabled;
            if (enabled) {
                startSTT();
            } else {
                if (recognition) recognition.stop();
                sttStatus.classList.add('hidden');
                sttStatus.classList.remove('flex');
            }
        }

        function startSTT() {
            if (!('webkitSpeechRecognition' in window)) {
                transcriptArea.value = "âš ï¸ æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜åŠŸèƒ½ (è«‹ä½¿ç”¨ Chrome / Edge)ã€‚";
                return;
            }

            if (!recognition) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'cmn-Hant-TW'; // ç¹é«”ä¸­æ–‡

                recognition.onstart = () => {
                    sttStatus.classList.remove('hidden');
                    sttStatus.classList.add('flex');
                };
                
                recognition.onerror = (event) => {
                    console.log('STT Error:', event.error);
                    sttStatus.classList.add('hidden');
                };

                recognition.onend = () => {
                    if (isSttOn) recognition.start(); // è‡ªå‹•é‡å•Ÿ
                    else sttStatus.classList.add('hidden');
                };

                recognition.onresult = (event) => {
                    let finalTranscript = '';
                    let interimTranscript = '';

                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            finalTranscript += event.results[i][0].transcript + '\n';
                        } else {
                            interimTranscript += event.results[i][0].transcript;
                        }
                    }
                    
                    if (finalTranscript) {
                        const now = new Date().toLocaleTimeString('zh-TW', {hour:'2-digit', minute:'2-digit'});
                        transcriptArea.value += `[${now}] ${finalTranscript}`;
                        transcriptArea.scrollTop = transcriptArea.scrollHeight;
                    }
                };
            }
            try { recognition.start(); } catch(e) {}
        }

        function copyTranscript() {
            navigator.clipboard.writeText(transcriptArea.value);
            const btn = document.querySelector('button[onclick="copyTranscript()"]');
            const original = btn.innerText;
            btn.innerText = "å·²è¤‡è£½ï¼";
            setTimeout(() => btn.innerText = original, 1000);
        }

        function clearTranscript() {
            transcriptArea.value = '';
        }

        // --- Timer ---
        function startTimer() {
            startTime = Date.now();
            timerInterval = setInterval(() => {
                const diff = Date.now() - startTime;
                const date = new Date(diff);
                timerEl.innerText = date.toISOString().substring(11, 19);
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            timerEl.innerText = "00:00:00";
        }
    </script>
</body>
</html>