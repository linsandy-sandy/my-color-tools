<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Virtuoso Piano Pro | 響應式合成器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { 
            background-color: #0f172a; 
            color: white; 
            font-family: 'Inter', sans-serif; 
            background-image: radial-gradient(#1e293b 1px, transparent 1px);
            background-size: 30px 30px;
            overflow: hidden; /* 禁止整個頁面捲動 */
            touch-action: none; /* 禁止瀏覽器預設手勢 */
        }

        /* --- 鋼琴容器外框 (Scrollable) --- */
        .piano-wrapper {
            width: 100%;
            height: 100%;
            overflow-x: auto;
            overflow-y: hidden;
            display: flex;
            justify-content: center; /* 電腦版預設置中 */
            align-items: center;
            position: relative;
            /* 讓這個區域可以左右滑動 (pan-x)，但在琴鍵上我們會覆蓋這個設定 */
            touch-action: pan-x; 
            scrollbar-width: thin;
            scrollbar-color: #475569 #1e293b;
        }
        
        /* 手機版靠左對齊，方便捲動 */
        @media (max-width: 768px) {
            .piano-wrapper {
                justify-content: flex-start;
                align-items: flex-end; /* 琴鍵靠下 */
            }
        }

        /* --- 鋼琴本體 --- */
        .piano-container {
            display: flex;
            position: relative;
            padding: 40px 10px 10px 10px; /* 上方預留 40px 給滑動條 */
            background: #1e293b;
            border-radius: 16px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            border-top: 4px solid #334155;
            min-width: fit-content;
            margin: 0 auto;
        }
        @media (max-width: 768px) {
            .piano-container {
                border-radius: 0; /* 手機版不需要圓角 */
                margin: 0;
                padding-bottom: 0;
                box-shadow: none;
                border: none;
                background: transparent;
            }
        }

        /* --- 滑動控制條 (Scroll Strip) --- */
        .scroll-strip {
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 35px;
            background: #334155;
            border-radius: 12px 12px 0 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #94a3b8;
            font-size: 10px;
            letter-spacing: 1px;
            cursor: grab;
            z-index: 5;
            touch-action: pan-x; /* 允許在此區域左右捲動 */
        }
        @media (max-width: 768px) {
            .scroll-strip {
                border-radius: 0;
                background: #1e293b;
                border-bottom: 1px solid #475569;
            }
        }

        /* --- 白鍵 --- */
        .key-white {
            width: 50px; 
            height: 220px;
            background: linear-gradient(to bottom, #fff 0%, #e2e8f0 100%);
            border: 1px solid #94a3b8;
            border-bottom: 4px solid #64748b;
            border-radius: 0 0 6px 6px;
            margin: 0 2px;
            position: relative;
            z-index: 1;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            padding-bottom: 10px;
            color: #94a3b8;
            font-size: 10px;
            font-weight: bold;
            user-select: none;
            /* 關鍵：在琴鍵上禁止瀏覽器捲動，這樣才能做滑音 (Glissando) */
            touch-action: none; 
        }
        /* 手機版白鍵尺寸調整 */
        @media (max-width: 768px) {
            .key-white {
                width: 42px; /* 變窄一點 */
                height: 60vh; /* 使用螢幕高度百分比 */
                max-height: 250px;
            }
        }
        /* 橫向模式優化 */
        @media (max-height: 500px) and (orientation: landscape) {
            .key-white {
                height: 65vh; 
                max-height: none;
            }
        }

        .key-white:active, .key-white.active {
            border-bottom-width: 1px;
            transform: translateY(3px); /* 保持高度，只做位移，避免手機版排版跳動 */
            background: #cbd5e1;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.2);
            color: #3b82f6;
        }

        /* --- 黑鍵 --- */
        .key-black {
            width: 32px;
            height: 130px;
            background: linear-gradient(to bottom, #334155 0%, #0f172a 100%);
            border: 1px solid #000;
            border-bottom: 4px solid #000;
            border-radius: 0 0 4px 4px;
            position: absolute;
            z-index: 2;
            cursor: pointer;
            pointer-events: auto; /* 讓黑鍵也能接收事件 */
            color: #64748b;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            padding-bottom: 10px;
            font-size: 9px;
            user-select: none;
            touch-action: none;
        }
        /* 手機版黑鍵尺寸 */
        @media (max-width: 768px) {
            .key-black {
                width: 26px;
                height: 38vh; /* 跟隨白鍵比例 */
                max-height: 160px;
            }
        }
        @media (max-height: 500px) and (orientation: landscape) {
            .key-black {
                height: 40vh;
                max-height: none;
            }
        }

        .key-black:active, .key-black.active {
            background: #000;
            border-bottom-width: 1px;
            border-color: #f472b6;
            box-shadow: 0 0 15px #f472b6;
            color: #f472b6;
        }

        .key-label { margin-bottom: 4px; opacity: 0.7; }
        .note-name { font-size: 8px; opacity: 0.5; }

        /* 手機版隱藏鍵盤按鍵提示 */
        @media (max-width: 768px) {
            .key-label { display: none; }
            .note-name { font-size: 10px; opacity: 0.8; }
        }

        /* --- 控制面板 --- */
        .control-panel {
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            transition: opacity 0.3s;
        }
        /* 橫向模式時，控制面板縮小或半透明 */
        @media (max-height: 500px) and (orientation: landscape) {
            .app-header { display: none; } /* 隱藏標題 */
            .control-panel {
                position: absolute;
                top: 10px; right: 10px;
                padding: 8px;
                margin: 0;
                transform: scale(0.8);
                transform-origin: top right;
            }
        }

        .wave-btn.selected {
            background-color: #ec4899;
            color: white;
            border-color: #ec4899;
        }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- 頂部導覽 (橫向模式會隱藏) -->
    <header class="app-header bg-slate-900/80 backdrop-blur border-b border-slate-700 p-3 flex justify-between items-center z-10 shrink-0">
        <div class="flex items-center gap-3">
            <a href="index.html" class="flex items-center justify-center w-8 h-8 rounded-full bg-slate-800 text-slate-400 hover:bg-pink-500 hover:text-white transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg>
            </a>
            <h1 class="text-lg font-bold bg-clip-text text-transparent bg-gradient-to-r from-pink-400 to-rose-500 tracking-wider">
                Virtuoso Piano <span class="text-[10px] border border-pink-500/50 text-pink-400 px-1 rounded ml-1 align-middle">Mobile</span>
            </h1>
        </div>
        <div class="text-[10px] text-slate-500 hidden md:block">
            Z~M (低) | Q~P (高)
        </div>
    </header>

    <!-- 鋼琴主體區 -->
    <main class="flex-grow flex flex-col items-center justify-center relative w-full overflow-hidden bg-slate-900">
        
        <!-- 控制面板 -->
        <div class="control-panel p-3 rounded-xl mb-4 flex gap-4 items-center shadow-xl z-20">
            <div class="flex flex-col items-center">
                <label class="block text-[10px] text-slate-400 mb-1 uppercase font-bold">VOL</label>
                <input type="range" id="volume" min="0" max="1" step="0.1" value="0.5" class="w-24 accent-pink-500 cursor-pointer h-2 bg-slate-700 rounded-lg appearance-none">
            </div>
            
            <div class="h-8 w-px bg-slate-600"></div>

            <div>
                <div class="flex gap-1">
                    <button class="wave-btn selected px-2 py-1 text-[10px] rounded border border-slate-600 text-slate-300 transition" onclick="setWave('triangle', this)">Piano</button>
                    <button class="wave-btn px-2 py-1 text-[10px] rounded border border-slate-600 text-slate-300 transition" onclick="setWave('square', this)">8-Bit</button>
                    <button class="wave-btn px-2 py-1 text-[10px] rounded border border-slate-600 text-slate-300 transition" onclick="setWave('sawtooth', this)">Synth</button>
                </div>
            </div>
        </div>

        <!-- 鋼琴捲動區 -->
        <div class="piano-wrapper" id="scroller">
            <div class="piano-container" id="keyboard">
                <div class="scroll-strip">
                    <svg class="w-4 h-4 mr-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16l-4-4m0 0l4-4m-4 4h18"></path></svg>
                    <span>DRAG HERE TO SCROLL</span>
                    <svg class="w-4 h-4 ml-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>
                </div>
                <!-- 鍵盤生成區 -->
            </div>
        </div>

    </main>

    <script>
        // 音符資料 (C3 ~ B5)
        const NOTES = [
            { note: 'C3', freq: 130.81, key: 'z', type: 'white' },
            { note: 'C#3', freq: 138.59, key: 's', type: 'black' },
            { note: 'D3', freq: 146.83, key: 'x', type: 'white' },
            { note: 'D#3', freq: 155.56, key: 'd', type: 'black' },
            { note: 'E3', freq: 164.81, key: 'c', type: 'white' },
            { note: 'F3', freq: 174.61, key: 'v', type: 'white' },
            { note: 'F#3', freq: 185.00, key: 'g', type: 'black' },
            { note: 'G3', freq: 196.00, key: 'b', type: 'white' },
            { note: 'G#3', freq: 207.65, key: 'h', type: 'black' },
            { note: 'A3', freq: 220.00, key: 'n', type: 'white' },
            { note: 'A#3', freq: 233.08, key: 'j', type: 'black' },
            { note: 'B3', freq: 246.94, key: 'm', type: 'white' },

            { note: 'C4', freq: 261.63, key: 'q', type: 'white' },
            { note: 'C#4', freq: 277.18, key: '2', type: 'black' },
            { note: 'D4', freq: 293.66, key: 'w', type: 'white' },
            { note: 'D#4', freq: 311.13, key: '3', type: 'black' },
            { note: 'E4', freq: 329.63, key: 'e', type: 'white' },
            { note: 'F4', freq: 349.23, key: 'r', type: 'white' },
            { note: 'F#4', freq: 369.99, key: '5', type: 'black' },
            { note: 'G4', freq: 392.00, key: 't', type: 'white' },
            { note: 'G#4', freq: 415.30, key: '6', type: 'black' },
            { note: 'A4', freq: 440.00, key: 'y', type: 'white' },
            { note: 'A#4', freq: 466.16, key: '7', type: 'black' },
            { note: 'B4', freq: 493.88, key: 'u', type: 'white' },

            { note: 'C5', freq: 523.25, key: 'i', type: 'white' },
            { note: 'C#5', freq: 554.37, key: '9', type: 'black' },
            { note: 'D5', freq: 587.33, key: 'o', type: 'white' },
            { note: 'D#5', freq: 622.25, key: '0', type: 'black' },
            { note: 'E5', freq: 659.25, key: 'p', type: 'white' },
            { note: 'F5', freq: 698.46, key: '[', type: 'white' },
            { note: 'F#5', freq: 739.99, key: '=', type: 'black' },
            { note: 'G5', freq: 783.99, key: ']', type: 'white' },
            { note: 'G#5', freq: 830.61, key: 'a', type: 'black' }, 
            { note: 'A5', freq: 880.00, key: ';', type: 'white' },
            { note: 'A#5', freq: 932.33, key: '\'', type: 'black' },
            { note: 'B5', freq: 987.77, key: '\\', type: 'white' }
        ];

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const keyboard = document.getElementById('keyboard');
        const scroller = document.getElementById('scroller');
        let currentWave = 'triangle'; 
        
        // 追蹤當前按下的按鍵 (支援多點觸控滑音)
        let activeTouches = new Map(); // identifier -> keyElement

        function initPiano() {
            // 清除之前的琴鍵 (保留 scroll-strip)
            const keys = keyboard.querySelectorAll('.key-white, .key-black');
            keys.forEach(k => k.remove());
            
            // 1. 渲染白鍵 (相對定位)
            NOTES.filter(n => n.type === 'white').forEach(n => {
                const k = createKeyElement(n);
                keyboard.appendChild(k);
            });

            // 2. 渲染黑鍵 (絕對定位)
            let whiteKeyIndex = 0;
            // 偵測螢幕寬度來決定鍵寬 (修正：手機版白鍵42+4=46px)
            const isMobile = window.innerWidth <= 768;
            const WHITE_WIDTH = isMobile ? 46 : 54; // 修正後的總寬度
            const BLACK_OFFSET = isMobile ? 13 : 18; 

            NOTES.forEach((n) => {
                if (n.type === 'white') {
                    whiteKeyIndex++;
                } else {
                    const k = createKeyElement(n);
                    // 計算黑鍵位置
                    k.style.left = `${(whiteKeyIndex * WHITE_WIDTH) - BLACK_OFFSET}px`; 
                    keyboard.appendChild(k);
                }
            });

            // 初始捲動到中間
            setTimeout(() => {
                const middleKey = document.querySelector('div[data-note="C4"]');
                if (middleKey && scroller) {
                    const center = middleKey.offsetLeft - (scroller.clientWidth / 2) + 25;
                    scroller.scrollTo({ left: center, behavior: 'smooth' });
                }
            }, 200);
        }

        // 監聽螢幕旋轉/調整大小，重新計算黑鍵位置
        window.addEventListener('resize', () => {
            initPiano();
        });

        function createKeyElement(n) {
            const key = document.createElement('div');
            key.className = n.type === 'white' ? 'key-white' : 'key-black';
            key.dataset.note = n.note; // 用 Note 當 ID
            key.dataset.key = n.key;
            key.dataset.freq = n.freq;
            
            key.innerHTML = `
                <span class="key-label">${n.key.toUpperCase()}</span>
                <span class="note-name">${n.note}</span>
            `;
            
            // 滑鼠事件 (電腦版)
            key.addEventListener('mousedown', (e) => {
                e.preventDefault();
                startNote(key);
            });
            key.addEventListener('mouseup', () => stopNote(key));
            key.addEventListener('mouseleave', () => stopNote(key));

            return key;
        }

        // --- 核心聲音合成 ---
        const compressor = audioCtx.createDynamicsCompressor();
        compressor.connect(audioCtx.destination);

        function playTone(freq) {
            if (audioCtx.state === 'suspended') audioCtx.resume();

            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            osc.type = currentWave;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            
            const volume = document.getElementById('volume').value;
            
            const now = audioCtx.currentTime;
            gainNode.gain.setValueAtTime(0, now);
            gainNode.gain.linearRampToValueAtTime(parseFloat(volume), now + 0.01); 
            gainNode.gain.exponentialRampToValueAtTime(0.001, now + 1.5); 

            osc.connect(gainNode);
            gainNode.connect(compressor);
            
            osc.start();
            osc.stop(now + 1.5);
        }

        function startNote(keyEl) {
            if (!keyEl || keyEl.classList.contains('active')) return;
            keyEl.classList.add('active');
            playTone(parseFloat(keyEl.dataset.freq));
        }

        function stopNote(keyEl) {
            if (keyEl) keyEl.classList.remove('active');
        }

        // --- 觸控事件處理 (Glissando / 滑音) ---
        // 我們將監聽整個 piano-container 的觸控事件，而不是個別按鍵
        // 這樣可以追蹤手指在按鍵上的移動
        
        keyboard.addEventListener('touchstart', handleTouch, {passive: false});
        keyboard.addEventListener('touchmove', handleTouch, {passive: false});
        keyboard.addEventListener('touchend', handleTouchEnd);
        keyboard.addEventListener('touchcancel', handleTouchEnd);

        function handleTouch(e) {
            // 如果觸碰到 scroll-strip，允許瀏覽器默認捲動，不攔截
            if (e.target.closest('.scroll-strip')) {
                return; 
            }

            // 如果是在琴鍵區域，阻止捲動，執行彈奏
            e.preventDefault(); 

            const touches = e.changedTouches;
            
            for (let i = 0; i < touches.length; i++) {
                const touch = touches[i];
                // 根據座標找到底下的元素
                const element = document.elementFromPoint(touch.clientX, touch.clientY);
                const keyEl = element ? element.closest('.key-white, .key-black') : null;

                // 處理新觸控或移動
                if (keyEl) {
                    const lastKey = activeTouches.get(touch.identifier);
                    // 如果手指移到了新的鍵
                    if (lastKey !== keyEl) {
                        if (lastKey) stopNote(lastKey); // 停止舊的
                        startNote(keyEl); // 播放新的
                        activeTouches.set(touch.identifier, keyEl);
                    }
                } else {
                    // 手指滑出鍵盤區域
                    const lastKey = activeTouches.get(touch.identifier);
                    if (lastKey) {
                        stopNote(lastKey);
                        activeTouches.delete(touch.identifier);
                    }
                }
            }
        }

        function handleTouchEnd(e) {
            const touches = e.changedTouches;
            for (let i = 0; i < touches.length; i++) {
                const touch = touches[i];
                const keyEl = activeTouches.get(touch.identifier);
                if (keyEl) {
                    stopNote(keyEl);
                    activeTouches.delete(touch.identifier);
                }
            }
        }

        // --- 鍵盤控制 (電腦版) ---
        document.addEventListener('keydown', (e) => {
            if (e.repeat || e.ctrlKey || e.altKey) return;
            const note = NOTES.find(n => n.key === e.key.toLowerCase());
            if (note) {
                const keyEl = document.querySelector(`div[data-note="${note.note}"]`);
                startNote(keyEl);
                if (keyEl) ensureVisible(keyEl);
            }
        });

        document.addEventListener('keyup', (e) => {
            const note = NOTES.find(n => n.key === e.key.toLowerCase());
            if (note) {
                const keyEl = document.querySelector(`div[data-note="${note.note}"]`);
                stopNote(keyEl);
            }
        });

        function ensureVisible(element) {
            if (!element) return;
            const containerLeft = scroller.scrollLeft;
            const containerRight = containerLeft + scroller.clientWidth;
            const elLeft = element.offsetLeft;
            const elRight = elLeft + element.clientWidth;

            if (elLeft < containerLeft) {
                scroller.scrollTo({ left: elLeft - 20, behavior: 'smooth' });
            } else if (elRight > containerRight) {
                scroller.scrollTo({ left: elRight - scroller.clientWidth + 20, behavior: 'smooth' });
            }
        }

        function setWave(type, btn) {
            currentWave = type;
            document.querySelectorAll('.wave-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
        }

        // 啟動
        initPiano();

    </script>
</body>
</html>