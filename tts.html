<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æœ—è®€æ©Ÿ | Text to Speech</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: white; }
        
        /* æ²è»¸ç¾åŒ– */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* é«˜äº®æ­£åœ¨æœ—è®€çš„å¥å­ */
        .highlight {
            background-color: rgba(251, 191, 36, 0.2); /* Amber-400 alpha */
            border-bottom: 2px solid #fbbf24;
            color: #fbbf24;
            padding: 2px 0;
            transition: all 0.2s;
        }

        /* é–±è®€æ¨¡å¼ä¸‹çš„æ–‡å­—å®¹å™¨ */
        #read-display {
            line-height: 1.8;
            letter-spacing: 0.05em;
            white-space: pre-wrap; /* ä¿ç•™æ›è¡Œ */
        }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <!-- å°è¦½åˆ— -->
    <nav class="border-b border-slate-700 bg-slate-900/80 backdrop-blur shrink-0 z-50">
        <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <a href="index.html" class="flex items-center gap-2 text-slate-400 hover:text-white transition-colors text-sm font-medium border border-slate-700 px-3 py-1.5 rounded-lg bg-slate-800">
                    <span>ğŸ </span>
                </a>
                <span class="font-bold text-lg text-pink-400 tracking-wide">AI æœ—è®€æ©Ÿ</span>
            </div>
            
            <!-- è¨­å®šå€ -->
            <div class="flex items-center gap-3">
                <div class="hidden sm:flex items-center gap-2 bg-slate-800 rounded-lg p-1 border border-slate-700">
                    <span class="text-xs text-slate-400 px-2">èªé€Ÿ</span>
                    <input type="range" id="rate" min="0.5" max="2" step="0.1" value="1" class="w-24 accent-pink-500 cursor-pointer" oninput="updateRateLabel(this.value)">
                    <span id="rate-label" class="text-xs text-white w-8 text-center">1.0x</span>
                </div>
                
                <select id="voiceSelect" class="bg-slate-800 border border-slate-700 text-white text-sm rounded-lg px-2 py-1.5 outline-none focus:border-pink-500 max-w-[150px] sm:max-w-[200px]">
                    <option value="">è¼‰å…¥èªéŸ³ä¸­...</option>
                </select>
            </div>
        </div>
    </nav>

    <!-- ä¸»ç•«é¢ -->
    <main class="flex-grow flex flex-col p-4 w-full max-w-5xl mx-auto overflow-hidden">
        
        <!-- 1. ç·¨è¼¯æ¨¡å¼ (è¼¸å…¥å€) -->
        <div id="edit-mode" class="flex-grow flex flex-col h-full">
            <div class="flex justify-between items-center mb-2">
                <label class="text-sm font-bold text-slate-400">è«‹è²¼ä¸Šæ–‡ç« å…§å®¹ï¼š</label>
                <button onclick="clearText()" class="text-xs text-slate-500 hover:text-red-400 underline">æ¸…ç©ºå…§å®¹</button>
            </div>
            <textarea id="text-input" class="w-full flex-grow bg-slate-800 border border-slate-700 rounded-2xl p-6 text-slate-200 focus:outline-none focus:border-pink-500 resize-none text-lg shadow-inner" placeholder="åœ¨æ­¤è²¼ä¸Šå°èªªã€æ–‡ç« æˆ–å ±å‘Šå…§å®¹... (å»ºè­°åˆ†æ®µè²¼ä¸Šï¼Œç€è¦½å™¨æ•ˆèƒ½è¼ƒä½³)"></textarea>
        </div>

        <!-- 2. é–±è®€æ¨¡å¼ (é¡¯ç¤ºå€) -->
        <div id="read-mode" class="hidden flex-grow flex-col h-full relative">
            <div class="flex justify-between items-center mb-2">
                <div class="text-sm font-bold text-slate-400">æ­£åœ¨æœ—è®€ï¼š <span id="progress-text" class="text-pink-400">0%</span></div>
                <button onclick="toggleMode()" class="text-xs text-blue-400 hover:text-blue-300 flex items-center gap-1">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                    ç·¨è¼¯æ–‡å­—
                </button>
            </div>
            <div id="read-display" class="w-full flex-grow bg-slate-800/50 border border-slate-700 rounded-2xl p-6 text-slate-300 overflow-y-auto text-lg shadow-inner relative">
                <!-- å…§å®¹ç”± JS ç”Ÿæˆ -->
            </div>
            <!-- è‡ªå‹•æ²å‹•é–å®šæŒ‰éˆ• -->
            <button id="auto-scroll-btn" class="absolute bottom-4 right-6 bg-slate-700/80 p-2 rounded-full text-pink-400 shadow-lg hover:bg-slate-600 transition-colors" onclick="toggleAutoScroll()" title="è‡ªå‹•æ²å‹•é–‹/é—œ">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg>
            </button>
        </div>

    </main>

    <!-- åº•éƒ¨æ§åˆ¶åˆ— -->
    <footer class="bg-slate-900 border-t border-slate-800 p-4 shrink-0">
        <div class="max-w-4xl mx-auto flex items-center justify-center gap-6">
            
            <button onclick="stop()" class="p-3 rounded-full text-slate-400 hover:bg-slate-800 hover:text-white transition-all" title="åœæ­¢ä¸¦é‡ç½®">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M6 6h12v12H6z"/></svg>
            </button>

            <button onclick="prevSentence()" class="p-3 rounded-full text-slate-400 hover:bg-slate-800 hover:text-white transition-all" title="ä¸Šä¸€å¥">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M11 18V6l-8.5 6 8.5 6zm.5-6l8.5 6V6l-8.5 6z"/></svg>
            </button>

            <!-- æ’­æ”¾/æš«åœå¤§æŒ‰éˆ• -->
            <button id="play-btn" onclick="togglePlay()" class="w-16 h-16 bg-gradient-to-br from-pink-500 to-rose-600 rounded-full flex items-center justify-center text-white shadow-lg shadow-pink-500/30 hover:scale-105 active:scale-95 transition-all">
                <svg id="icon-play" class="w-8 h-8 ml-1" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                <svg id="icon-pause" class="w-8 h-8 hidden" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
            </button>

            <button onclick="nextSentence()" class="p-3 rounded-full text-slate-400 hover:bg-slate-800 hover:text-white transition-all" title="ä¸‹ä¸€å¥">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M4 18l8.5-6L4 6v12zm9-12v12l8.5-6L13 6z"/></svg>
            </button>
            
            <!-- æ¨¡å¼åˆ‡æ›æŒ‰éˆ• (é¡¯ç¤ºåœ¨æ‰‹æ©Ÿç‰ˆåº•éƒ¨) -->
            <button onclick="toggleMode()" class="sm:hidden p-3 rounded-full text-blue-400 hover:bg-slate-800 transition-all" title="åˆ‡æ›é–±è®€æ¨¡å¼">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
            </button>

        </div>
    </footer>

    <script>
        // --- è®Šæ•¸å€ ---
        const synth = window.speechSynthesis;
        let voices = [];
        let sentences = []; // åˆ‡å‰²å¾Œçš„å¥å­é™£åˆ—
        let currentIndex = 0; // ç›®å‰è®€åˆ°ç¬¬å¹¾å¥
        let isPlaying = false;
        let isPaused = false;
        let autoScroll = true;
        let currentUtterance = null;

        // UI å…ƒç´ 
        const textInput = document.getElementById('text-input');
        const readDisplay = document.getElementById('read-display');
        const editMode = document.getElementById('edit-mode');
        const readMode = document.getElementById('read-mode');
        const voiceSelect = document.getElementById('voiceSelect');
        const playBtn = document.getElementById('play-btn');
        const iconPlay = document.getElementById('icon-play');
        const iconPause = document.getElementById('icon-pause');
        const rateSlider = document.getElementById('rate');
        const progressText = document.getElementById('progress-text');

        // --- åˆå§‹åŒ– ---
        window.onload = () => {
            loadVoices();
            // å˜—è©¦è®€å–ä¸Šæ¬¡å…§å®¹
            const savedText = localStorage.getItem('tts_content');
            if(savedText) textInput.value = savedText;
        };

        // --- èªéŸ³è¼‰å…¥é‚è¼¯ (åŒ ebook.html) ---
        function loadVoices() {
            voices = synth.getVoices();
            voiceSelect.innerHTML = '';
            
            const zhVoices = voices.filter(v => v.lang.includes('zh'));
            if(zhVoices.length === 0) {
                voiceSelect.innerHTML = '<option value="">æœªåµæ¸¬åˆ°ä¸­æ–‡èªéŸ³</option>';
                return;
            }

            zhVoices.forEach(v => {
                const opt = document.createElement('option');
                let label = v.name;
                if (v.lang === 'zh-TW' || v.name.includes('Taiwan')) label = `ğŸ‡¹ğŸ‡¼ ${v.name}`;
                opt.value = v.name;
                opt.textContent = label;
                voiceSelect.appendChild(opt);
            });

            // è‡ªå‹•é¸æœ€å¥½çš„
            const best = getBestVoice();
            if(best) voiceSelect.value = best.name;
        }

        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = loadVoices;
        }

        function getBestVoice() {
            const priorities = ["Yating", "Hanhan", "Zhiwei", "Google åœ‹èªï¼ˆå°ç£ï¼‰", "Meijia"];
            const twVoices = voices.filter(v => v.lang === 'zh-TW');
            for (const p of priorities) {
                const found = twVoices.find(v => v.name.includes(p));
                if (found) return found;
            }
            if (twVoices.length > 0) return twVoices[0];
            return voices.find(v => v.lang.includes('zh'));
        }

        function updateRateLabel(val) {
            document.getElementById('rate-label').innerText = val + 'x';
        }

        // --- æ ¸å¿ƒï¼šæ–‡å­—è™•ç†èˆ‡æ’­æ”¾ ---
        
        function prepareSentences() {
            const text = textInput.value.trim();
            if(!text) return false;
            
            localStorage.setItem('tts_content', text); // è‡ªå‹•å­˜æª”

            // æ™ºæ…§åˆ†æ®µï¼šä¾ç…§æ¨™é»ç¬¦è™Ÿåˆ‡å‰²ï¼Œä½†ä¿ç•™æ¨™é»ç¬¦è™Ÿåœ¨å¥å­è£¡
            // Regex: åŒ¹é… (ä»»ä½•éæ¨™é»å­—å…ƒ) + (æ¨™é»å­—å…ƒ æˆ– æ›è¡Œ)
            // æ¨™é»åŒ…å«ï¼š. ? ! ; ã€‚ ï¼Ÿ ï¼ ï¼› â€¦ ä»¥åŠæ›è¡Œ
            // é€™æ˜¯ä¸€å€‹ç°¡å–®çš„åˆ‡åˆ†ï¼Œå¯èƒ½ç„¡æ³•å®Œç¾è™•ç†æ‰€æœ‰ç‹€æ³ï¼Œä½†å°æœ—è®€å¤ ç”¨äº†
            const rawSentences = text.split(/([.ã€‚ï¼Ÿ?ï¼!ï¼›;\n]+)/);
            
            sentences = [];
            for (let i = 0; i < rawSentences.length; i += 2) {
                const content = rawSentences[i];
                const punct = rawSentences[i+1] || ""; // æ¨™é»å¯èƒ½åœ¨æœ€å¾Œæ²’æœ‰
                if (content.trim().length > 0) {
                    sentences.push(content + punct);
                }
            }
            
            // å¦‚æœåˆ‡åˆ†å¤±æ•—ï¼ˆä¾‹å¦‚æ²’æ¨™é»ï¼‰ï¼Œå°±æŠŠæ•´æ®µç•¶ä¸€å¥
            if(sentences.length === 0 && text.length > 0) sentences = [text];

            return true;
        }

        function renderReadDisplay() {
            readDisplay.innerHTML = '';
            sentences.forEach((s, i) => {
                const span = document.createElement('span');
                span.id = `sent-${i}`;
                span.textContent = s;
                // é»æ“Šå¥å­å¯ä»¥ç›´æ¥è·³è½‰æ’­æ”¾
                span.className = "cursor-pointer hover:bg-slate-700/50 rounded px-1 transition-colors";
                span.onclick = () => { currentIndex = i; speakCurrentSentence(); };
                readDisplay.appendChild(span);
            });
        }

        function toggleMode() {
            if (editMode.classList.contains('hidden')) {
                // åˆ‡å›ç·¨è¼¯
                editMode.classList.remove('hidden');
                readMode.classList.add('hidden');
                stop(); // åœæ­¢æ’­æ”¾
            } else {
                // é€²å…¥é–±è®€
                if(prepareSentences()) {
                    renderReadDisplay();
                    editMode.classList.add('hidden');
                    readMode.classList.remove('hidden');
                    currentIndex = 0;
                    highlightSentence(0);
                } else {
                    alert("è«‹å…ˆè¼¸å…¥å…§å®¹ï¼");
                }
            }
        }

        function togglePlay() {
            if (editMode.classList.contains('hidden') === false) {
                // å¦‚æœé‚„åœ¨ç·¨è¼¯æ¨¡å¼ï¼Œå…ˆåˆ‡æ›éå»
                if(!prepareSentences()) { alert("è«‹å…ˆè¼¸å…¥å…§å®¹ï¼"); return; }
                renderReadDisplay();
                editMode.classList.add('hidden');
                readMode.classList.remove('hidden');
                currentIndex = 0;
                play();
            } else {
                // åœ¨é–±è®€æ¨¡å¼ä¸­
                if (isPlaying) {
                    pause();
                } else {
                    if (isPaused) resume();
                    else play();
                }
            }
        }

        function play() {
            if(sentences.length === 0) return;
            isPlaying = true;
            isPaused = false;
            updatePlayBtn();
            speakCurrentSentence();
        }

        function pause() {
            synth.cancel(); // ç›´æ¥ cancel æ¯”è¼ƒä¹¾è„†ï¼Œå› ç‚º resume åœ¨æŸäº›ç€è¦½å™¨æœ‰ bug
            isPlaying = false;
            isPaused = true; // æ¨™è¨˜ç‚ºæš«åœç‹€æ…‹ï¼Œä¸‹æ¬¡å¾åŒä¸€å¥é–‹å§‹
            updatePlayBtn();
        }

        function resume() {
            isPlaying = true;
            isPaused = false;
            updatePlayBtn();
            speakCurrentSentence(); // é‡æ–°æ’­æ”¾ç•¶å‰å¥å­
        }

        function stop() {
            synth.cancel();
            isPlaying = false;
            isPaused = false;
            currentIndex = 0;
            updatePlayBtn();
            highlightSentence(0); // é‡ç½®é«˜äº®
        }

        function prevSentence() {
            if(currentIndex > 0) {
                currentIndex--;
                if(isPlaying) speakCurrentSentence();
                else highlightSentence(currentIndex);
            }
        }

        function nextSentence() {
            if(currentIndex < sentences.length - 1) {
                currentIndex++;
                if(isPlaying) speakCurrentSentence();
                else highlightSentence(currentIndex);
            }
        }

        function speakCurrentSentence() {
            synth.cancel(); // ç¢ºä¿ä¸Šä¸€å¥åœæ‰

            if (currentIndex >= sentences.length) {
                stop(); // è®€å®Œäº†
                return;
            }

            const text = sentences[currentIndex];
            highlightSentence(currentIndex);
            updateProgress();

            const utterance = new SpeechSynthesisUtterance(text);
            
            // è¨­å®šèªéŸ³
            const selectedVoiceName = voiceSelect.value;
            if(selectedVoiceName) {
                utterance.voice = voices.find(v => v.name === selectedVoiceName);
            }
            utterance.rate = parseFloat(rateSlider.value);

            utterance.onend = () => {
                if (isPlaying) {
                    currentIndex++;
                    speakCurrentSentence(); // è‡ªå‹•ä¸‹ä¸€å¥
                }
            };

            utterance.onerror = (e) => {
                console.error("Speech Error", e);
                // é‡åˆ°éŒ¯èª¤å˜—è©¦ä¸‹ä¸€å¥ï¼Œé¿å…å¡æ­»
                if (isPlaying) {
                    currentIndex++;
                    speakCurrentSentence();
                }
            };

            synth.speak(utterance);
        }

        function highlightSentence(index) {
            // ç§»é™¤èˆŠé«˜äº®
            const old = document.querySelector('.highlight');
            if(old) old.classList.remove('highlight');

            // æ–°å¢é«˜äº®
            const el = document.getElementById(`sent-${index}`);
            if(el) {
                el.classList.add('highlight');
                if(autoScroll) {
                    el.scrollIntoView({ behavior: "smooth", block: "center" });
                }
            }
        }

        function updateProgress() {
            const pct = Math.round(((currentIndex + 1) / sentences.length) * 100);
            progressText.innerText = `${pct}% (${currentIndex + 1}/${sentences.length})`;
        }

        function updatePlayBtn() {
            if (isPlaying) {
                iconPlay.classList.add('hidden');
                iconPause.classList.remove('hidden');
            } else {
                iconPlay.classList.remove('hidden');
                iconPause.classList.add('hidden');
            }
        }

        function clearText() {
            if(confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰å…§å®¹å—ï¼Ÿ")) {
                textInput.value = "";
                stop();
                localStorage.removeItem('tts_content');
            }
        }

        function toggleAutoScroll() {
            autoScroll = !autoScroll;
            const btn = document.getElementById('auto-scroll-btn');
            btn.style.opacity = autoScroll ? "1" : "0.5";
        }

    </script>
</body>
</html>