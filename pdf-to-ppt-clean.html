<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF è½‰ PowerPoint (é«˜ç•«è³ªä¿çœŸç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PPT ç”Ÿæˆåº« -->
    <script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
    <!-- PDF è§£æåº« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        
        .drop-zone {
            transition: all 0.3s ease;
        }
        .drop-zone:hover, .drop-zone.dragover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }

        .slide-preview {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s;
        }
        .slide-preview:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col text-slate-800">

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-5xl mx-auto px-6 py-4 flex justify-between items-center">
            
            <div class="flex items-center gap-4">
                <!-- Home Button -->
                <a href="index.html" class="flex items-center justify-center w-10 h-10 rounded-full bg-slate-100 text-slate-500 hover:bg-blue-50 hover:text-blue-600 transition-colors shadow-sm" title="å›é¦–é ">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
                    </svg>
                </a>
                
                <div class="h-6 w-px bg-slate-300"></div>

                <div class="flex items-center gap-2">
                    <span class="text-2xl">ğŸ“Š</span>
                    <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600">
                        PDF è½‰ PowerPoint <span class="text-xs text-slate-500 font-normal ml-2 border border-slate-200 rounded px-2 py-0.5">è¦–è¦ºä¿çœŸç‰ˆ</span>
                    </h1>
                </div>
            </div>

            <button id="btn-convert" onclick="generatePPT()" disabled 
                class="bg-slate-200 text-slate-400 font-bold py-2 px-6 rounded-lg transition-all cursor-not-allowed flex items-center gap-2">
                <span>â¬‡ï¸</span> ä¸‹è¼‰ PPT
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow max-w-5xl mx-auto w-full px-6 py-8">
        
        <!-- Upload Area -->
        <div class="mb-8">
            <label class="drop-zone block w-full border-3 border-dashed border-slate-300 rounded-xl p-10 text-center cursor-pointer bg-white">
                <input type="file" id="fileInput" accept="application/pdf" class="hidden" onchange="handleFile(this)">
                <div class="text-5xl mb-4">ğŸ“‚</div>
                <h3 class="text-lg font-bold text-slate-700">é»æ“Šä¸Šå‚³ PDF ç°¡å ±</h3>
                <p class="text-slate-500 mt-2 text-sm">æ”¯æ´å‘é‡æ–‡å­—èˆ‡åœ–ç‰‡ï¼Œ100% é‚„åŸæ’ç‰ˆ</p>
            </label>
        </div>

        <!-- Processing Status -->
        <div id="status-area" class="hidden mb-8 bg-blue-50 border border-blue-100 rounded-lg p-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="animate-spin h-5 w-5 border-2 border-blue-600 border-t-transparent rounded-full"></div>
                <span id="status-text" class="text-blue-700 font-medium">æ­£åœ¨åˆ†æ PDF...</span>
            </div>
            <span id="page-count" class="text-blue-600 text-sm font-bold"></span>
        </div>

        <!-- Preview Grid -->
        <div id="preview-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Previews will be injected here -->
        </div>

    </main>

    <!-- Footer -->
    <footer class="text-center py-6 text-slate-400 text-sm">
        <p>ç­–ç•¥ï¼šå°‡é é¢è½‰ç‚ºé«˜ç•«è³ªåœ–ç‰‡ (Slide) + æŠ½å–æ–‡å­—è‡³å‚™å¿˜éŒ„ (Notes)</p>
    </footer>

    <!-- Invisible Canvas -->
    <canvas id="render-canvas" class="hidden"></canvas>

    <script>
        let pdfDoc = null;
        let pdfFileName = "presentation";

        // 1. è™•ç†æª”æ¡ˆä¸Šå‚³
        function handleFile(input) {
            const file = input.files[0];
            if (!file) return;
            
            pdfFileName = file.name.replace('.pdf', '');
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                const typedarray = new Uint8Array(e.target.result);
                try {
                    document.getElementById('status-area').classList.remove('hidden');
                    document.getElementById('status-text').innerText = "æ­£åœ¨è®€å– PDF çµæ§‹...";
                    
                    pdfDoc = await pdfjsLib.getDocument(typedarray).promise;
                    
                    document.getElementById('status-text').innerText = `è®€å–æˆåŠŸï¼å…± ${pdfDoc.numPages} é `;
                    document.getElementById('page-count').innerText = "";
                    
                    // å•Ÿç”¨ä¸‹è¼‰æŒ‰éˆ•
                    const btn = document.getElementById('btn-convert');
                    btn.disabled = false;
                    btn.classList.remove('bg-slate-200', 'text-slate-400', 'cursor-not-allowed');
                    btn.classList.add('bg-blue-600', 'hover:bg-blue-700', 'text-white', 'shadow-lg');
                    
                    // ç”¢ç”Ÿç¸®åœ–é è¦½
                    renderPreviews();

                } catch (err) {
                    console.error(err);
                    alert("PDF è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæœªåŠ å¯†ã€‚");
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // 2. æ¸²æŸ“é è¦½åœ– (åªæ¸²æŸ“å‰ 6 é ä»¥ç¯€çœæ•ˆèƒ½)
        async function renderPreviews() {
            const grid = document.getElementById('preview-grid');
            grid.innerHTML = '';
            
            const maxPreview = Math.min(pdfDoc.numPages, 6);
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            for(let i=1; i<=maxPreview; i++) {
                const page = await pdfDoc.getPage(i);
                const viewport = page.getViewport({ scale: 0.5 }); // é è¦½ç”¨ä½è§£æåº¦
                
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                
                await page.render({ canvasContext: ctx, viewport: viewport }).promise;
                
                const card = document.createElement('div');
                card.className = "bg-white p-3 rounded-lg slide-preview";
                card.innerHTML = `
                    <div class="aspect-video bg-slate-100 rounded overflow-hidden mb-3 border border-slate-200">
                        <img src="${canvas.toDataURL()}" class="w-full h-full object-contain">
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-xs font-bold text-slate-500">ç¬¬ ${i} é </span>
                        <span class="text-xs text-green-600 bg-green-50 px-2 py-0.5 rounded">å¯è½‰æ›</span>
                    </div>
                `;
                grid.appendChild(card);
            }
            
            if (pdfDoc.numPages > 6) {
                const moreMsg = document.createElement('div');
                moreMsg.className = "col-span-full text-center text-slate-500 py-4";
                moreMsg.innerText = `...ä»¥åŠå…¶ä»– ${pdfDoc.numPages - 6} é  (ä¸‹è¼‰å¾Œå¯è¦‹)`;
                grid.appendChild(moreMsg);
            }
        }

        // 3. æ ¸å¿ƒåŠŸèƒ½ï¼šç”Ÿæˆ PPT
        async function generatePPT() {
            if (!pdfDoc) return;
            
            const btn = document.getElementById('btn-convert');
            const statusText = document.getElementById('status-text');
            const originalText = btn.innerHTML;
            
            btn.disabled = true;
            btn.innerHTML = `<span class="animate-spin">â³</span> è™•ç†ä¸­...`;
            
            const pptx = new PptxGenJS();
            pptx.layout = 'LAYOUT_16x9';
            
            const canvas = document.getElementById('render-canvas');
            const ctx = canvas.getContext('2d');

            try {
                for (let i = 1; i <= pdfDoc.numPages; i++) {
                    statusText.innerText = `æ­£åœ¨è½‰æ›ç¬¬ ${i} / ${pdfDoc.numPages} é ...`;
                    
                    const page = await pdfDoc.getPage(i);
                    
                    // A. é«˜ç•«è³ªæ¸²æŸ“ (Scale 2.0 = 2å€æ¸…æ™°åº¦)
                    // é€™æ˜¯ PPT èƒŒæ™¯åœ–çš„é—œéµï¼ŒScale è¶Šé«˜è¶Šæ¸…æ™°ä½†æª”æ¡ˆè¶Šå¤§
                    const viewport = page.getViewport({ scale: 2.0 });
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    
                    await page.render({ canvasContext: ctx, viewport: viewport }).promise;
                    const imgData = canvas.toDataURL('image/jpeg', 0.8); // 80% å“è³ª JPEG
                    
                    // B. æå–æ–‡å­— (Text Extraction)
                    // å˜—è©¦è®€å– PDF å…§éƒ¨çš„æ–‡å­—å±¤
                    let extractedText = "";
                    try {
                        const textContent = await page.getTextContent();
                        // å°‡æ–‡å­—ç‰‡æ®µçµ„åˆèµ·ä¾†
                        extractedText = textContent.items.map(item => item.str).join(" ");
                    } catch (e) {
                        console.warn("ç„¡æ³•æå–æ–‡å­—:", e);
                    }

                    // C. å»ºç«‹ PPT é é¢
                    let slide = pptx.addSlide();
                    
                    // è¨­å®šèƒŒæ™¯ç‚º PDF æˆªåœ– (è¦–è¦ºå®Œç¾)
                    slide.background = { data: imgData };
                    
                    // å°‡æå–çš„æ–‡å­—æ”¾å…¥ã€Œå‚™å¿˜éŒ„ã€
                    if (extractedText.trim().length > 0) {
                        slide.addNotes(extractedText);
                    }
                }

                statusText.innerText = "æ‰“åŒ…ä¸‹è¼‰ä¸­...";
                await pptx.writeFile({ fileName: `${pdfFileName}_converted.pptx` });
                
                statusText.innerText = "è½‰æ›å®Œæˆï¼";
                btn.innerHTML = originalText;
                btn.disabled = false;

            } catch (err) {
                console.error(err);
                alert("è½‰æ›éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†é é¢å†è©¦ã€‚");
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }
    </script>
</body>
</html>